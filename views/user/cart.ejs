<!DOCTYPE html>
<html lang="en">

<head>
    <title>FAVADA</title>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
        integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous" />
    <!-- Import font Roboto -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />
    <!-- Font Awesome -->
    <script src="/script/fontawesome-pro.js"></script>
    <!-- Style -->
    <link rel="stylesheet" href="/css/cart.css" />
    <link rel="stylesheet" href="/css/style.css" />
</head>

<body>
    <!-- Begin Header -->
    <%- include('header.ejs') %>
    <!-- End Header -->

    <!-- Breadcrumb begin-->
    <div class="breadcrumb p-1 d-none d-sm-block">
        <div class="container">
            <a href="/">Trang chủ</a>
            <i class="far fa-angle-right mx-2"></i>
            <a>Giỏ hàng</a>
        </div>
    </div>
    <!-- Breadcrumb end -->
    <br />

    <div class="shopping-cart-area">
        <div class="container">
            <div class="row">
                <div class="col-12 px-0">
                    <% if (cartProducts) { %>
                    <form>
                        <div class="table-responsive">
                            <table class="product-table">
                                <thead>
                                    <tr>
                                        <th class="product-remove">Xóa</th>
                                        <th class="product-thumbnail">Sản phẩm</th>
                                        <th class="product-infor">Mô tả</th>
                                        <th class="product-price">Đơn giá</th>
                                        <th class="product-quantity">Số lượng</th>
                                        <th class="product-subtotal">Thành tiền</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% for (var i = 0; i < cartProducts.length; ++i) { %>
                                    <tr>
                                        <td class="product-remove">
                                            <button id="remove-cart-<%= cartProducts[i].id %>"
                                                onclick="removeFromCart('<%= cartProducts[i].id %>')">
                                                <i class="far fa-trash-alt"></i>
                                            </button>
                                        </td>
                                        <td class="product-thumbnail">
                                            <a href="/product/<%= cartProducts[i].id %>">
                                                <img src="<%= cartProducts[i].image %>" alt="Li's Product Image" class="w-75"/>
                                            </a>
                                        </td>
                                        <td class="product-infor" style="max-width: 270px;">
                                            <%= cartProducts[i].name %>
                                        </td>
                                        <td class="product-price">
                                            <%= (cartProducts[i].price*(100-cartProducts[i].promo)/100).toLocaleString('vi',{style:'currency',currency:'VND'}) %>
                                        </td>
                                        <td class="product-quantity">
                                            <div class="row justify-content-center">
                                                <input id="read-quantity-<%= cartProducts[i].id %>" class="change-quantity-box" 
                                                value="<%= cartProducts[i].quantity %>" type="number" readonly 
                                            onchange="quantityChange(this,'<%= i %>')"/>
                                                <div class="">
                                                    <div class="inc qtybutton">
                                                        <i class="fa fa-angle-up"></i>
                                                    </div>
                                                    <div class="dec qtybutton">
                                                        <i class="fa fa-angle-down"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="product-subtotal">
                                            <span class="amount">
                                            <%=((cartProducts[i].price*(100-cartProducts[i].promo)/100) * cartProducts[i].quantity).toLocaleString('vi',{style:'currency',currency:'VND'})%>
                                            </span>
                                        </td>
                                    </tr>
                                    <% } %>
                                </tbody>
                            </table>
                        </div>
                        <br>
                        <a class="continue-shopping py-2" href="/">
                            <i class="far fa-angle-left mr-2"></i>
                            Tiếp tục mua sắm
                        </a>
                        <div class="row mt-sm-3">
                            <div class="col-md-5 cart-page-total ml-auto px-0">
                                <h3>Tổng đơn hàng</h3>
                                <table>
                                    <% var tmpTotal = 0;
                                    for (var p of cartProducts) {
                                        tmpTotal += (p.price*(100-p.promo)/100)*p.quantity;
                                    } %>
                                    <tr>
                                        <td class="li-head">Tạm tính:</td>
                                        <td class="temp-total money">
                                            <%=tmpTotal.toLocaleString('vi',{style:'currency',currency:'VND'})%>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="li-head">Phí giao hàng</td>
                                        <td class="shipping-cost money">21.000đ</td>
                                    </tr>
                                </table>
                                <div class="coupon-apply-area row">
                                    <div class="coupon-apply-text col-9 px-0"><input type="text"
                                            placeholder="Nhập mã giảm giá" /></div>
                                    <button class="coupon-apply-btn col-3 px-0">Áp dụng</button>
                                </div>
                                <div class="total-cost row">
                                    <div class="total-text col-7">Tổng cộng:</div>
                                    <div class="total-money col-5">
                                        <%=(tmpTotal+21000).toLocaleString('vi',{style:'currency',currency:'VND'})%>
                                    </div>
                                </div>
                                <button class="proceed-checkout-btn" onclick="location.href=''" type="button">
                                    Xác nhận giỏ hàng và thanh toán
                                </button>
                            </div>
                        </div>
                    </form>
                    <% } else { %>
                    <div class="empty-board text-center">
                        <div class="my-5">
                            <img src="/images/empty.jpg" alt="Empty">
                        </div>
                        <div class="my-3">
                            Không có sản phẩm nào trong Giỏ hàng.
                        </div>
                        <div class="mb-5 mt-4">
                            <button class="btn-continue-shopping" onclick="location.href='/'">
                                Tiếp tục mua sắm
                            </button>
                        </div>
                    </div>
                    <% } %>
                
                </div>
            </div>
        </div>
    </div>

    <br />
    <br />
    <br />
    <!-- Footer begin -->
    <footer>
        <div class="container pt-3 pb-1">
            <div class="row d-flex justify-content-between no-gutters">
                <div class="col-lg-6 pr-lg-5">
                    <div>
                        <h5>ĐỊA ĐIỂM MUA HÀNG</h5>
                        <h2 class="line"></h2>
                        <ul class="list-unstyled">
                            <li>
                                <dl style="list-style: none;">
                                    <dt>
                                        <i class="fas fa-map-marker-alt mr-2"></i>227 Đường Nguyễn Văn Cừ, phường 4,
                                        quận 5, Hồ Chí Minh
                                    </dt>
                                    <dd>Thứ 2 - Thứ 6: Từ 9h - 20h</dd>
                                    <dd>
                                        Thứ 7: Từ 9h - 18h, Chủ Nhật: Từ 9h
                                        - 16h
                                    </dd>
                                    <dt>
                                        <i class="fas fa-map-marker-alt mr-2"></i>Khu phố 6, Phường Linh Trung, Quận
                                        Thủ Đức, Hồ Chí Minh
                                    </dt>
                                    <dd>Thứ 2 - Thứ 7: Từ 9h - 18h</dd>
                                    <dd>Chủ Nhật: Không hoạt động</dd>
                                </dl>
                            </li>
                        </ul>
                    </div>

                    <div>
                        <h5>ĐIỆN THOẠI HỖ TRỢ</h5>
                        <h2 class="line"></h2>
                        <ul class="list-unstyled normal-text">
                            <li>Mua hàng: <b>0843 969 899</b></li>
                            <li>
                                Bảo hành: <b>0843 969 899 (Line: 8200)</b>
                            </li>
                            <li>
                                Kỹ thuật: <b>0843 969 899 (Line: 8345)</b>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="col-lg-3 pr-lg-5">
                    <h5>CHÍNH SÁCH</h5>
                    <h2 class="line"></h2>
                    <ul class="list-unstyled normal-text">
                        <li>Chính sách bán hàng</li>
                        <li>Chính sách bảo hành</li>
                        <li>Chính sách bảo mật</li>
                        <li>Tìm hiểu về trả góp</li>
                    </ul>
                </div>
                <div class="col-lg-3">
                    <div>
                        <h5>PHƯƠNG THỨC THANH TOÁN</h5>
                        <h2 class="line"></h2>
                        <img src="/images/footer/visa.svg" width="54" class="mr-3" />
                        <img src="/images/footer/maestro.svg" width="54" class="mr-3" />
                        <img src="/images/footer/american-express.svg" width="54" class="mr-3" />
                        <img src="/images/footer/jcb.svg" width="54" class="mr-3" />
                        <img src="/images/footer/paypal.svg" width="54" class="mr-3" />
                        <img src="/images/footer/ebay.svg" width="54" />
                    </div>
                    <br />
                    <br />
                    <div>
                        <h5>KẾT NỐI VỚI CHÚNG TÔI</h5>
                        <h2 class="line"></h2>
                        <img src="/images/footer/facebook.svg" width="40" class="mr-3" />
                        <img src="/images/footer/youtube.svg" width="50" />
                    </div>
                </div>
            </div>
        </div>
        <div>
            <div class="container p-0">
                <div class="row no-gutters">
                    <span class="col-md-10 col-sm-9 text-right">Powered by Team10 - 17CNTN</span>
                    <span class="col-md-2 col-sm-3 text-right">@Favada 2020</span>
                </div>
            </div>
        </div>
    </footer>
    <!-- Footer end -->

    <!-- Optional JavaScript -->
    <script src="/script/public.js"></script>
    <script>
        var Products = <%- JSON.stringify(cartProducts) %>;

        function removeFromCart(productID) {
            let _id = parseInt(productID);
            // request delete in database
            makeRequest('/cart/' + productID, 'DELETE', jwtToken, 'Đã xóa khỏi Giỏ hàng');
            // delete in storage
            const i = cartProductIDs.indexOf(_id);
            cartProductIDs.splice(i, 1);
            localStorage.setItem("cartProductIDs", JSON.stringify(cartProductIDs));
            // reload list view, don't know why but must reload 2 times :((
            window.location.reload(true);
            window.location.reload(true);
        }
        // change quantity of product
        var btnsQuantity = document.querySelectorAll(".qtybutton");
        btnsQuantity.forEach(btn => { 
            btn.onclick = () => {
                var q = btn.parentElement.parentElement.querySelector("input");
                var oldVal = q.value;
                var newVal = null;
                if (btn.classList.contains("inc")) {
                    newVal = parseFloat(oldVal) + 1;
                } else {
                    // Don't allow decrementing below zero
                    if (oldVal > 1) {
                        newVal = parseFloat(oldVal) - 1;
                    } else {
                        newVal = 1;
                    }
                }
                q.value = newVal;
                // Trigger change event
                var event = new Event('change');
                // Dispatch it.
                q.dispatchEvent(event);
            }
        });
        function quantityChange(e, idx) {
            let i = parseInt(idx);
            Products[i].quantity = parseInt(e.value);
            let subTotal = e.parentElement.parentElement.parentElement.querySelector('span.amount');
            let p = Products[i];
            subTotal.innerHTML = ((p.price*(100-p.promo)/100) * p.quantity).toLocaleString('vi',{style:'currency',currency:'VND'});
            let tmpTotal = document.querySelector('.temp-total');
            let total = document.querySelector('.total-money');
            let a = 0;
            for (var x of Products) {
                a += (x.price*(100-x.promo)/100) * x.quantity;
            }
            tmpTotal.innerHTML = a.toLocaleString('vi',{style:'currency',currency:'VND'});
            total.innerHTML = (a+21000).toLocaleString('vi',{style:'currency',currency:'VND'});

            let reqUrl = '/cart/' + p.id + '?quantity=' + p.quantity;
            makeRequest(reqUrl, 'PUT', jwtToken, null);
        }
    </script>
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
        integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous">
    </script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous">
    </script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"
        integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous">
    </script>
</body>

</html>